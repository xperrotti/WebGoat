# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# The Checkmarx One GitHub Action enables you to trigger SAST, SCA, and KICS scans directly from the GitHub workflow.
# It provides a wrapper around the Checkmarx One CLI Tool which creates a zip archive from your source code repository
# and uploads it to Checkmarx One for scanning. The Github Action provides easy integration with GitHub while enabling
# scan customization using the full functionality and flexibility of the CLI tool.

# This is a basic workflow to help you get started with Using Checkmarx One Action,
# documentation can be found here : https://checkmarx.com/resource/documents/en/34965-68702-checkmarx-one-github-actions.html

name: Checkmarx Scan

# Controls when the workflow will run
on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [ "main" ]

permissions:
  contents: read

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif

    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # This step checks out a copy of your repository.
      - name: Checkout repository
        uses: actions/checkout@v3
      # This step creates the Checkmarx One scan
      - name: Checkmarx One scan
        uses: checkmarx/ast-github-action@8e887bb93dacc44e0f5b64ee2b06d5815f89d4fc
        with:
          base_uri: https://eu.ast.checkmarx.net  # This should be replaced by your base uri for Checkmarx One
          cx_client_id: "ast-app" # This should be created within your Checkmarx One account : https://checkmarx.com/resource/documents/en/34965-118315-authentication-for-checkmarx-one-cli.html#UUID-a4e31a96-1f36-6293-e95a-97b4b9189060_UUID-4123a2ff-32d0-2287-8dd2-3c36947f675e
          cx_client_secret: "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJOMnNMQVhQZFVWSzViZllCU0xhOGlRZ3ZRMTFsZnZPMFBrVWVaWjIteWxNIn0.eyJleHAiOjE2ODEzOTc1NDQsImlhdCI6MTY4MTM5NTc0NCwianRpIjoiY2E3MzVkYTgtODkwNC00N2I2LTgyYzctZTdkYWM2ZWNiMDZhIiwiaXNzIjoiaHR0cHM6Ly9ldS5pYW0uY2hlY2ttYXJ4Lm5ldC9hdXRoL3JlYWxtcy9iZXRhX25vdmE4IiwiYXVkIjpbInJlYWxtLW1hbmFnZW1lbnQiLCJhY2NvdW50Il0sInN1YiI6IjY2OTFmNDk4LTExMzktNDQ4MC1hYjJkLTZmNTkwMjViYjE4ZiIsInR5cCI6IkJlYXJlciIsImF6cCI6ImFzdC1hcHAiLCJzZXNzaW9uX3N0YXRlIjoiOWJjYjg3YmMtNDg4YS00ZTgxLTg1OGItOTJhODVmY2M2NTk0IiwiYWxsb3dlZC1vcmlnaW5zIjpbIioiLCIvKiJdLCJyZXNvdXJjZV9hY2Nlc3MiOnsicmVhbG0tbWFuYWdlbWVudCI6eyJyb2xlcyI6WyJ2aWV3LXJlYWxtIiwibWFuYWdlLWtleXMiLCJ2aWV3LWNsaWVudHMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktZ3JvdXBzIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6Imdyb3VwcyBvZmZsaW5lX2FjY2VzcyBhc3QtYXBpIGlhbS1hcGkgZW1haWwgcHJvZmlsZSByb2xlcyIsInNpZCI6IjliY2I4N2JjLTQ4OGEtNGU4MS04NThiLTkyYTg1ZmNjNjU5NCIsInRlbmFudF9pZCI6ImV1LmlhbS5jaGVja21hcngubmV0OjoxNGExN2UwYS1hM2EzLTQ4ZTQtYjY0NS1kNzlmZWVkZTg5ZmYiLCJ0ZW5hbnRfbmFtZSI6ImJldGFfbm92YTgiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInJvbGVzIjpbImRlZmF1bHQtcm9sZXMtMTRhMTdlMGEtYTNhMy00OGU0LWI2NDUtZDc5ZmVlZGU4OWZmIiwib2ZmbGluZV9hY2Nlc3MiLCJtYW5hZ2Uta2V5cyIsInVtYV9hdXRob3JpemF0aW9uIiwidXNlciJdLCJldWxhLWFjY2VwdGVkIjp0cnVlLCJncm91cHMiOlsiOGRjOTQwNTItNWE1Zi00ODVhLWJhMjItODQ3MjIyMDNlN2I3Il0sImdyb3Vwc05hbWVzIjpbIkNhbmRpZGF0b3MiXSwiY2ItdXJsIjoiIiwicHJlZmVycmVkX3VzZXJuYW1lIjoicm9iZXJ0by5wZXJyb3R0aSIsImdpdmVuX25hbWUiOiJSb2JlcnRvIiwiYXN0LWJhc2UtdXJsIjoiaHR0cHM6Ly9ldS5hc3QuY2hlY2ttYXJ4Lm5ldCIsInNmLWlkIjoiMDAxRDAwMDAwMXRkeHZMSUFRIiwicm9sZXNfYXN0IjpbImNyZWF0ZS1wcm9qZWN0Iiwidmlldy1wcm9qZWN0cyIsInZpZXctcHJlc2V0IiwiZGVsZXRlLXNjYW4taWYtaW4tZ3JvdXAiLCJ1cGRhdGUtcHJvamVjdC1pZi1pbi1ncm91cCIsInVwZGF0ZS1wcmVzZXQiLCJ2aWV3LXByb2plY3RzLWlmLWluLWdyb3VwIiwiYXN0LXNjYW5uZXIiLCJ1cGRhdGUtc2NhbiIsIkNhbmRpZGF0b3MiLCJ2aWV3LXByb2plY3QtcGFyYW1zIiwidXBkYXRlLXNjYW4taWYtaW4tZ3JvdXAiLCJ2aWV3LWFwcGxpY2F0aW9ucyIsInZpZXctcXVlcmllcyIsImRlbGV0ZS1wcm9qZWN0LWlmLWluLWdyb3VwIiwidXBkYXRlLXByb2plY3QtcGFyYW1zIiwiY3JlYXRlLXNjYW4taWYtaW4tZ3JvdXAiLCJ1cGRhdGUtcHJvamVjdC1wYXJhbXMtaWYtaW4tZ3JvdXAiLCJjcmVhdGUtcHJlc2V0IiwidXBkYXRlLXJlc3VsdC1ub3QtZXhwbG9pdGFibGUtaWYtaW4tZ3JvdXAiLCJ2aWV3LXJlc3VsdHMtaWYtaW4tZ3JvdXAiLCJhY2Nlc3MtaWFtIiwidXBkYXRlLXJlc3VsdC1pZi1pbi1ncm91cCIsInZpZXctdGVuYW50LXBhcmFtcyIsInZpZXctc2NhbnMtaWYtaW4tZ3JvdXAiLCJ2aWV3LXJlc3VsdHMiLCJ2aWV3LXByb2plY3QtcGFyYW1zLWlmLWluLWdyb3VwIiwidmlldy1zY2FucyIsImNyZWF0ZS1zY2FuIiwidXBkYXRlLXByb2plY3QiXSwibmFtZSI6IlJvYmVydG8gUGVycm90dGkgRmlsaG8iLCJ0ZW5hbnQtdHlwZSI6IkN1c3RvbWVyIiwiYXN0LWxpY2Vuc2UiOnsiSUQiOjE4ODgsIlRlbmFudElEIjoiMTRhMTdlMGEtYTNhMy00OGU0LWI2NDUtZDc5ZmVlZGU4OWZmIiwiSXNBY3RpdmUiOnRydWUsIlBhY2thZ2VJRCI6NSwiTGljZW5zZURhdGEiOnsiYWN0aXZhdGlvbkRhdGUiOjE2MjYzMzQ3NTc3NzYsImFsbG93ZWRFbmdpbmVzIjpbIlNBU1QiLCJTQ0EiLCJLSUNTIiwiQ29udGFpbmVycyIsIkZ1c2lvbiIsIkFQSSBTZWN1cml0eSJdLCJhcGlTZWN1cml0eUVuYWJsZWQiOnRydWUsImNvZGVCYXNoaW5nRW5hYmxlZCI6ZmFsc2UsImNvZGVCYXNoaW5nVXJsIjoiIiwiY29kZUJhc2hpbmdVc2Vyc0NvdW50IjoxMCwiY3VzdG9tTWF4Q29uY3VycmVudFNjYW5zRW5hYmxlZCI6ZmFsc2UsImRhc3RFbmFibGVkIjpmYWxzZSwiZXhwaXJhdGlvbkRhdGUiOjE2NDUwODY0ODAwMDAsImZlYXR1cmVzIjpbIlNTTyJdLCJtYXhDb25jdXJyZW50U2NhbnMiOjEsInNjc0VuYWJsZWQiOmZhbHNlLCJzZXJ2aWNlVHlwZSI6IlN0YW5kYXJkIiwic2VydmljZXMiOlsiMCBPcHRpbWl6YXRpb24gU2VydmljZSBPcmRlciIsIjAgQXBwc2VjIEhlbHBkZXNrIEFzc2lzdGFuY2UiXSwidW5saW1pdGVkUHJvamVjdHMiOnRydWUsInVzZXJzQ291bnQiOjUwfSwiUGFja2FnZU5hbWUiOiJBZHZhbmNlZCJ9LCJzZXJ2aWNlX3VzZXJzX2VuYWJsZWQiOnRydWUsImZhbWlseV9uYW1lIjoiUGVycm90dGkgRmlsaG8iLCJlbWFpbCI6InJwZXJyb3R0aWZpbGhvQGdtYWlsLmNvbSIsInRlbmFudCI6ImJldGFfbm92YTgifQ.VoCnyLgTyfvsOlT-Qmr_EWfKA5SfPsbaaWMusbPyleMhcUJ5YY6YORRcjtxDo6REzl9z9uULJFR4ww3SyUgwGJjl9BYYNgn2WbzxqyWZ0X43tAUSjGqvuhN80iMWoZrrULprGHyaYK7S8qkDC2lg2grUetAHBnW2XJSmF3KnknpRVaBrnHWVZMG0mDS9QjQu7dOBYPTr-Zljeopf6E83tisQPrUaB1aYy4t6cMcxAz2Qm8UGcyyk4w8ouN6HZo6MHcZiy3NYa82PyzrxT1FfiUT_F1pPNVkb_xBcQbzQ_YqSeyH5YMZ7DrD61ekhEFJiuwUiY5Lpg5w-oX9wukkzJQ" # This should be created within your Checkmarx One account : https://checkmarx.com/resource/documents/en/34965-118315-authentication-for-checkmarx-one-cli.html#UUID-a4e31a96-1f36-6293-e95a-97b4b9189060_UUID-4123a2ff-32d0-2287-8dd2-3c36947f675e
          cx_tenant: ${{ secrets.CX_TENANT }} # This should be replaced by your tenant for Checkmarx One
          additional_params: --report-format sarif --output-path .
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          # Path to SARIF file relative to the root of the repository
          sarif_file: cx_result.sarif
